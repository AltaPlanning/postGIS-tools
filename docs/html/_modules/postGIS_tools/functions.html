

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>postGIS_tools.functions &mdash; postGIS_tools 1.2.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> postGIS_tools
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">postGIS-tools</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">postGIS_tools</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>postGIS_tools.functions</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for postGIS_tools.functions</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>

<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">from</span> <span class="nn">geoalchemy2</span> <span class="k">import</span> <span class="n">Geometry</span><span class="p">,</span> <span class="n">WKTElement</span>


<span class="kn">from</span> <span class="nn">postGIS_tools.configurations</span> <span class="k">import</span> <span class="n">THIS_SYSTEM</span>
<span class="kn">from</span> <span class="nn">postGIS_tools.queries.hexagon_grid</span> <span class="k">import</span> <span class="n">hex_grid_function</span>
<span class="kn">from</span> <span class="nn">postGIS_tools.logs</span> <span class="k">import</span> <span class="n">log_activity</span>
<span class="kn">from</span> <span class="nn">postGIS_tools.constants</span> <span class="k">import</span> <span class="n">PG_PASSWORD</span>

<span class="c1">################################################################################</span>
<span class="c1"># CONNECT TO THE DATABASE</span>
<span class="c1">################################################################################</span>


<div class="viewcode-block" id="make_database_connection"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.make_database_connection">[docs]</a><span class="k">def</span> <span class="nf">make_database_connection</span><span class="p">(</span>
        <span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a connection object to a PostgreSQL database.</span>

<span class="sd">    :param db_name: name of the database (string). eg: &#39;aa_santa_clara&#39;</span>
<span class="sd">    :param method: name of library (string). Either &#39;psycopg2&#39; or &#39;sqlalchemy&#39;</span>
<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>
<span class="sd">    :return: `psycopg2.connect()` or `sqlalcehmy.create_engine()` object to be used for database I/O operations</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">uri</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;postgresql://</span><span class="si">{username}</span><span class="s1">:</span><span class="si">{password}</span><span class="s1">@</span><span class="si">{host}</span><span class="s1">:</span><span class="si">{port}</span><span class="s1">/</span><span class="si">{db_name}</span><span class="s1">&#39;</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Using </span><span class="si">{method}</span><span class="s2"> to connect to:</span><span class="se">\n\t</span><span class="si">{uri}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;sqlalchemy&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;psycopg2&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span></div>

<span class="c1">################################################################################</span>
<span class="c1"># GET BASIC THINGS OUT OF THE DATABASE</span>
<span class="c1">################################################################################</span>


<div class="viewcode-block" id="fetch_things_from_database"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.fetch_things_from_database">[docs]</a><span class="k">def</span> <span class="nf">fetch_things_from_database</span><span class="p">(</span>
        <span class="n">query</span><span class="p">,</span>
        <span class="n">database</span><span class="p">,</span>
        <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use ``psycopg2`` to send query to database and return the ``.fetchall()`` result.</span>

<span class="sd">    TODO: type hints and params</span>

<span class="sd">    :param query: &#39;SELECT * FROM my_table&#39;</span>
<span class="sd">    :param database: &#39;name_of_the_database&#39;</span>
<span class="sd">    :param host: by default is &#39;localhost&#39;, but could also be &#39;192.168.1.14&#39;</span>
<span class="sd">    :return: cursor.fetchall() object (list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;QUERYING VIA psycopg2:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="n">connection</span> <span class="o">=</span> <span class="n">make_database_connection</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s1">&#39;psycopg2&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="get_list_of_tables_in_db"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.get_list_of_tables_in_db">[docs]</a><span class="k">def</span> <span class="nf">get_list_of_tables_in_db</span><span class="p">(</span>
        <span class="n">database</span><span class="p">,</span>
        <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list of all tables that exist in a given database.</span>

<span class="sd">    TODO: type hints and params</span>

<span class="sd">    :param database: &#39;name_of_the_database&#39;</span>
<span class="sd">    :param host: by default is &#39;localhost&#39;, but could also be &#39;192.168.1.14&#39;</span>
<span class="sd">    :return: list of all tables in database</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="c1"># Get a list of all tables that are currently in the database</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT table_name FROM information_schema.tables WHERE table_schema = &#39;public&#39;&quot;&quot;&quot;</span>

    <span class="n">tables</span> <span class="o">=</span> <span class="n">fetch_things_from_database</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="n">tables_to_ignore</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;geography_columns&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry_columns&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;spatial_ref_sys&#39;</span><span class="p">,</span> <span class="s1">&#39;raster_columns&#39;</span><span class="p">,</span> <span class="s1">&#39;raster_overviews&#39;</span><span class="p">]</span>

    <span class="n">table_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tables</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables_to_ignore</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">table_names</span></div>


<div class="viewcode-block" id="get_full_list_of_tables_in_db"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.get_full_list_of_tables_in_db">[docs]</a><span class="k">def</span> <span class="nf">get_full_list_of_tables_in_db</span><span class="p">(</span>
        <span class="n">database</span><span class="p">,</span>
        <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a FULL list of all tables that exist in a given database.</span>
<span class="sd">    Unlike ``get_list_of_tables_in_db()``, this one does not ignore the following tables:</span>
<span class="sd">    - &#39;geography_columns&#39;</span>
<span class="sd">    - &#39;geometry_columns&#39;</span>
<span class="sd">    - &#39;spatial_ref_sys&#39;</span>
<span class="sd">    - &#39;raster_columns&#39;</span>
<span class="sd">    - &#39;raster_overviews&#39;</span>

<span class="sd">    TODO: type hints and params</span>

<span class="sd">    :param database: &#39;name_of_the_database&#39;</span>
<span class="sd">    :param host: by default is &#39;localhost&#39;, but could also be &#39;192.168.1.14&#39;</span>
<span class="sd">    :return: list of all tables in database</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="c1"># Get a list of all tables that are currently in the database</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT table_name FROM information_schema.tables WHERE table_schema = &#39;public&#39;&quot;&quot;&quot;</span>

    <span class="n">tables</span> <span class="o">=</span> <span class="n">fetch_things_from_database</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="n">table_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">table_names</span></div>


<div class="viewcode-block" id="get_list_of_columns_in_table"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.get_list_of_columns_in_table">[docs]</a><span class="k">def</span> <span class="nf">get_list_of_columns_in_table</span><span class="p">(</span>
        <span class="n">database</span><span class="p">,</span>
        <span class="n">table</span><span class="p">,</span>
        <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list of all columns that exist in a given table</span>

<span class="sd">    TODO: type hints and params</span>

<span class="sd">    :param database: &#39;name_of_the_database&#39;</span>
<span class="sd">    :param table: &#39;name_of_the_table&#39;</span>
<span class="sd">    :param host: by default is &#39;localhost&#39;, but could also be &#39;192.168.1.14&#39;</span>
<span class="sd">    :return: list of columns</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT column_name </span>
<span class="s2">            FROM information_schema.columns </span>
<span class="s2">            WHERE table_schema = &#39;public&#39;</span>
<span class="s2">            AND table_name = &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="n">raw_result</span> <span class="o">=</span> <span class="n">fetch_things_from_database</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">raw_result</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="get_list_of_spatial_tables_in_db"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.get_list_of_spatial_tables_in_db">[docs]</a><span class="k">def</span> <span class="nf">get_list_of_spatial_tables_in_db</span><span class="p">(</span>
        <span class="n">database</span><span class="p">,</span>
        <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list of all spatial tables that exist in a given database.</span>

<span class="sd">    :param database: &#39;name_of_the_database&#39;</span>
<span class="sd">    :param host: by default is &#39;localhost&#39;, but could also be &#39;192.168.1.14&#39;</span>
<span class="sd">    :return: list of all spatial tables in database</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="c1"># Get a list of all tables that are currently in the database</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT f_table_name AS tblname FROM geometry_columns&quot;&quot;&quot;</span>

    <span class="n">spatial_tables</span> <span class="o">=</span> <span class="n">fetch_things_from_database</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="n">spatial_table_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">spatial_tables</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">spatial_table_names</span></div>

<span class="c1">################################################################################</span>
<span class="c1"># QUERY THE DATABASE AND RETURN AS DATAFRAME</span>
<span class="c1">################################################################################</span>


<div class="viewcode-block" id="query_table"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.query_table">[docs]</a><span class="k">def</span> <span class="nf">query_table</span><span class="p">(</span>
        <span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query a table in a database and get the result as a ``pandas.DataFrame``</span>

<span class="sd">    :param db_name: &#39;name_of_the_database&#39;</span>
<span class="sd">    :param query: &#39;SELECT * FROM my_table&#39;</span>
<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>
<span class="sd">    :return: ``pandas.DataFrame``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;QUERYING...&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="n">engine</span> <span class="o">=</span> <span class="n">make_database_connection</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="s1">&#39;sqlalchemy&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>

    <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="query_geo_table"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.query_geo_table">[docs]</a><span class="k">def</span> <span class="nf">query_geo_table</span><span class="p">(</span>
        <span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">geom_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;geom&#39;</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query a geo table in a SQL database and get the result as a ``geopandas.GeoDataFrame``</span>

<span class="sd">    Be aware of the name of the geometry column. In PostGIS it&#39;s typically called &#39;geom&#39;,</span>
<span class="sd">    but geopandas seems to expect &#39;geometry&#39; instead.</span>

<span class="sd">    TODO: type hints and params</span>

<span class="sd">    :param db_name: &#39;name_of_the_database&#39;</span>
<span class="sd">    :param query: &#39;SELECT gid, pop2015, geom FROM my_table WHERE pop2015 &gt; 1000&#39;</span>
<span class="sd">    :param geom_col: the name of the geometry column. Should either be &#39;geom&#39; or &#39;geometry&#39;</span>
<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>
<span class="sd">    :return: ``geopandas.GeoDataFrame``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;QUERYING...&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="n">connection</span> <span class="o">=</span> <span class="n">make_database_connection</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="s1">&#39;psycopg2&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_postgis</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">geom_col</span><span class="o">=</span><span class="n">geom_col</span><span class="p">)</span>

    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">gdf</span></div>


<span class="c1">################################################################################</span>
<span class="c1"># UPDATE THINGS IN THE DATABASE</span>
<span class="c1">################################################################################</span>


<div class="viewcode-block" id="execute_query"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.execute_query">[docs]</a><span class="k">def</span> <span class="nf">execute_query</span><span class="p">(</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use ``psycopg2`` to execute and commit a SQL command in the database.</span>

<span class="sd">    :param database: &#39;name_of_the_database&#39;</span>
<span class="sd">    :param query: &#39;DROP VIEW IF EXISTS my_view;&#39;</span>
<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;UPDATING via psycopg2:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

    <span class="n">connection</span> <span class="o">=</span> <span class="n">make_database_connection</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s1">&#39;psycopg2&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">runtime</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> COMMITTED IN - </span><span class="si">{runtime}</span><span class="s1"> seconds&#39;</span><span class="p">)</span>

    <span class="n">log_activity</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;pGIS.execute_query&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span></div>

<div class="viewcode-block" id="add_or_nullify_column"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.add_or_nullify_column">[docs]</a><span class="k">def</span> <span class="nf">add_or_nullify_column</span><span class="p">(</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tbl</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">data_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a column to a table if it doesn&#39;t exist yet</span>
<span class="sd">    If it does exist, set the entire column to NULL</span>

<span class="sd">    :param database: &#39;name_of_database&#39;</span>
<span class="sd">    :param tbl: &#39;name_of_table&#39;</span>
<span class="sd">    :param column: &#39;col_name&#39;</span>
<span class="sd">    :param data_type: any valid PgSQL type: &#39;TEXT&#39;, &#39;FLOAT&#39;, etc.</span>
<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="n">existing_cols</span> <span class="o">=</span> <span class="n">get_list_of_columns_in_table</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
    <span class="n">col_exists</span> <span class="o">=</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">existing_cols</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">col_exists</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;&#39;&#39;ALTER TABLE </span><span class="si">{tbl}</span><span class="s1"> ADD COLUMN </span><span class="si">{column}</span><span class="s1"> </span><span class="si">{data_type}</span><span class="s1">;&#39;&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot; UPDATE </span><span class="si">{tbl}</span><span class="s2"> SET </span><span class="si">{column}</span><span class="s2"> = NULL  &quot;&quot;&quot;</span>

    <span class="n">execute_query</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="n">log_activity</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;pGIS.add_or_nullify_column&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span></div>


<div class="viewcode-block" id="drop_table"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.drop_table">[docs]</a><span class="k">def</span> <span class="nf">drop_table</span><span class="p">(</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tablename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Drop a table from a PostgreSQL database</span>

<span class="sd">    :param database: name of the database (string)</span>
<span class="sd">    :param tablename: name of the table to drop (string)</span>
<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="n">drop_table_query</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;DROP TABLE </span><span class="si">{tablename}</span><span class="s1"> CASCADE;&#39;</span>
    <span class="n">execute_query</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">drop_table_query</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="n">log_activity</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;pGIS.drop_table&quot;</span><span class="p">,</span> <span class="n">drop_table_query</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span></div>


<div class="viewcode-block" id="project_spatial_table"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.project_spatial_table">[docs]</a><span class="k">def</span> <span class="nf">project_spatial_table</span><span class="p">(</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tablename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">geom_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">orig_epsg</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">new_epsg</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Alter a table&#39;s ``geom`` column to a new EPSG</span>

<span class="sd">    TODO: type hints and params</span>

<span class="sd">    :param database: name of the database (string)</span>
<span class="sd">    :param tablename: name of the table (string)</span>
<span class="sd">    :param geom_type: name of a SQL-valid geometry type (string)</span>
<span class="sd">    :param orig_epsg: the EPSG that the data currently has (integer)</span>
<span class="sd">    :param new_epsg: the EPSG you want the data to be projected into (integer)</span>
<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="n">qry</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;&#39;&#39;ALTER TABLE </span><span class="si">{tablename}</span><span class="s1"></span>
<span class="s1">              ALTER COLUMN geom TYPE geometry(</span><span class="si">{geom_type}</span><span class="s1">, </span><span class="si">{new_epsg}</span><span class="s1">) </span>
<span class="s1">              USING ST_Transform( ST_SetSRID( geom, </span><span class="si">{orig_epsg}</span><span class="s1"> ), </span><span class="si">{new_epsg}</span><span class="s1"> ); &#39;&#39;&#39;</span>
    <span class="n">execute_query</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">qry</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="n">log_activity</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;pGIS.project_spatial_table&quot;</span><span class="p">,</span> <span class="n">qry</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span></div>


<div class="viewcode-block" id="prep_spatial_table"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.prep_spatial_table">[docs]</a><span class="k">def</span> <span class="nf">prep_spatial_table</span><span class="p">(</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">spatial_table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Spatial tables in QGIS coming from PostGIS need a unique ID column and a spatial index.</span>
<span class="sd">    This function executes the two SQL queries needed.</span>
<span class="sd">    Results in a new column called ``unique_id`` and a spatial index on the existing ``geom`` column</span>

<span class="sd">    :param database: &#39;name_of_the_db&#39;</span>
<span class="sd">    :param spatial_table_name: &#39;name_of_the_table&#39;</span>
<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>
<span class="sd">    :return: nothing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="c1"># Add a primary key column named &#39;unique_id&#39;</span>
    <span class="n">unique_id_query</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;ALTER TABLE </span><span class="si">{spatial_table_name}</span><span class="s1"> ADD unique_id serial PRIMARY KEY;&#39;</span>
    <span class="n">execute_query</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">unique_id_query</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># Create a spatial index on the &#39;geom&#39; column</span>
    <span class="n">spatial_index_query</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;CREATE INDEX gix_</span><span class="si">{spatial_table_name}</span><span class="s1"> ON </span><span class="si">{spatial_table_name}</span><span class="s1"> USING GIST (geom);&#39;</span>
    <span class="n">execute_query</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">spatial_index_query</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="n">log_activity</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;pGIS.prep_spatial_table&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;Add unique_id PK and make spatial index on geom column&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span></div>


<div class="viewcode-block" id="register_geometry_column"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.register_geometry_column">[docs]</a><span class="k">def</span> <span class="nf">register_geometry_column</span><span class="p">(</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">spatial_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">geom_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Point&#39;</span><span class="p">,</span>
        <span class="n">epsg</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4326</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run this query if your spatial table has an error in QGIS saying:</span>
<span class="sd">    ``There isn&#39;t an entry in geometry_columns``.</span>
<span class="sd">    Seems to be related to when you make new spatial tables via query</span>
<span class="sd">    Spatial tables imported via geopandas do not seem to have this problem</span>

<span class="sd">    TODO: type hints and params</span>

<span class="sd">    :param database: &#39;name_of_db&#39;</span>
<span class="sd">    :param spatial_table: &#39;name_of_table&#39;</span>
<span class="sd">    :param geom_type: a valid PostGIS geom type, as string: &#39;Point&#39;</span>
<span class="sd">    :param epsg: the EPSG that the data is already in. This does not transform anything</span>
<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>
<span class="sd">    :return: nothing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="n">query</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;&#39;&#39; ALTER TABLE </span><span class="si">{spatial_table}</span><span class="s1"></span>
<span class="s1">                 ALTER COLUMN geom TYPE geometry(</span><span class="si">{geom_type}</span><span class="s1">, </span><span class="si">{epsg}</span><span class="s1">) </span>
<span class="s1">                                        USING ST_SetSRID(geom, </span><span class="si">{epsg}</span><span class="s1">)&#39;&#39;&#39;</span>
    <span class="n">execute_query</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
    <span class="n">log_activity</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;pGIS.register_geometry_column&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_geotable_from_query"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.make_geotable_from_query">[docs]</a><span class="k">def</span> <span class="nf">make_geotable_from_query</span><span class="p">(</span>
        <span class="n">database</span><span class="p">,</span>
        <span class="n">new_tblname</span><span class="p">,</span>
        <span class="n">query</span><span class="p">,</span>
        <span class="n">geom_colname</span><span class="o">=</span><span class="s1">&#39;geom&#39;</span><span class="p">,</span>
        <span class="n">geom_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;POINT&#39;</span><span class="p">,</span>
        <span class="n">epsg</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4326</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Quickly make a new spatial table in PostgreSQL with a query,</span>
<span class="sd">    using ``geopandas`` and other downstream functions to take care of table setup in the database.</span>

<span class="sd">    This avoids doing the setup manually, which includes adding a primary key, spatial index, etc.</span>

<span class="sd">    TODO: type hints and params</span>

<span class="sd">    :param database: &#39;my_database&#39;</span>
<span class="sd">    :param new_tblname: &#39;name_of_my_new_table&#39;</span>
<span class="sd">    :param query: &quot;SELECT * FROM my_table WHERE highway = &#39;Local&#39; &quot;</span>
<span class="sd">    :param geom_colname: &#39;geom&#39;</span>
<span class="sd">    :param host: &#39;localhost&#39;</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="c1"># Confirm that the geom type is valid</span>
    <span class="n">valid_geom_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;POINT&quot;</span><span class="p">,</span> <span class="s2">&quot;MULTIPOINT&quot;</span><span class="p">,</span> <span class="s2">&quot;POLYGON&quot;</span><span class="p">,</span> <span class="s2">&quot;MULTIPOLYGON&quot;</span><span class="p">,</span> <span class="s2">&quot;LINESTRING&quot;</span><span class="p">,</span> <span class="s2">&quot;MULTILINESTRING&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">geom_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_geom_types</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Geometry type of </span><span class="si">{geom_type}</span><span class="s2"> is not valid.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Please use one of the following: </span><span class="si">{valid_geom_types}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Aborting&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;MAKING </span><span class="si">{new_tblname}</span><span class="s1"> FROM:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="n">full_query</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        DROP TABLE IF EXISTS </span><span class="si">{new_tblname}</span><span class="s2">;</span>
<span class="s2">        CREATE TABLE </span><span class="si">{new_tblname}</span><span class="s2"> AS</span>
<span class="s2">        </span><span class="si">{query}</span><span class="s2"></span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">execute_query</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">full_query</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
    <span class="n">log_activity</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;pGIS.make_geotable_from_query&quot;</span><span class="p">,</span> <span class="n">full_query</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="n">prep_spatial_table</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">new_tblname</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="n">register_geometry_column</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">new_tblname</span><span class="p">,</span> <span class="n">geom_type</span><span class="o">=</span><span class="n">geom_type</span><span class="p">,</span> <span class="n">epsg</span><span class="o">=</span><span class="n">epsg</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span></div>

<span class="c1">################################################################################</span>
<span class="c1"># MAKE A NEW DATABASE</span>
<span class="c1">################################################################################</span>


<div class="viewcode-block" id="load_hexgrid_function"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.load_hexgrid_function">[docs]</a><span class="k">def</span> <span class="nf">load_hexgrid_function</span><span class="p">(</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute SQL code that defines the ``hex_grid()`` function in the database.</span>

<span class="sd">    :param database: &#39;name_of_the_database&#39;</span>
<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Loading the hex_grid() function into </span><span class="si">{database}</span><span class="s1"> on </span><span class="si">{host}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">execute_query</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">hex_grid_function</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
    <span class="n">log_activity</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;pGIS.load_hexgrid_function&quot;</span><span class="p">,</span> <span class="s2">&quot;see pGIS.queries.hexagon_grid.py&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_new_database"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.make_new_database">[docs]</a><span class="k">def</span> <span class="nf">make_new_database</span><span class="p">(</span>
        <span class="n">database_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">default_db</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;postgres&quot;</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a new PostgreSQL database, load PostGIS, and define a custom hexagon function</span>

<span class="sd">    :param database_name: &#39;name_of_the_database&#39;</span>
<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="c1"># check to see if this database already exists</span>
    <span class="n">exists_qry</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot; SELECT EXISTS(</span>
<span class="s2">                        SELECT datname FROM pg_catalog.pg_database WHERE lower(datname) = lower(&#39;</span><span class="si">{database_name}</span><span class="s2">&#39;)</span>
<span class="s2">                     );  &quot;&quot;&quot;</span>

    <span class="n">exist_query_response</span> <span class="o">=</span> <span class="n">query_table</span><span class="p">(</span><span class="n">default_db</span><span class="p">,</span> <span class="n">exists_qry</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="n">exists_result</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">exists</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">exist_query_response</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>

    <span class="k">if</span> <span class="s1">&#39;False&#39;</span> <span class="ow">in</span> <span class="n">exists_result</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Make new database routine for: </span><span class="si">{database_name}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">make_db</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;CREATE DATABASE </span><span class="si">{database_name}</span><span class="s2">;&quot;</span>

        <span class="n">c_postgres</span> <span class="o">=</span> <span class="n">make_database_connection</span><span class="p">(</span><span class="n">default_db</span><span class="p">,</span> <span class="s1">&#39;psycopg2&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="n">c_postgres</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">ISOLATION_LEVEL_AUTOCOMMIT</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">c_postgres</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">make_db</span><span class="p">)</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">c_postgres</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">c_postgres</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">log_activity</span><span class="p">(</span><span class="n">database_name</span><span class="p">,</span> <span class="s2">&quot;pGIS.make_new_database&quot;</span><span class="p">,</span> <span class="n">make_db</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># Check if PostGIS already exists by default. If not, add it.</span>
        <span class="k">if</span> <span class="s1">&#39;geometry_columns&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">get_full_list_of_tables_in_db</span><span class="p">(</span><span class="n">database_name</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;Adding postGIS extension to </span><span class="si">{database_name}</span><span class="s1">&#39;</span>
            <span class="n">execute_query</span><span class="p">(</span><span class="n">database_name</span><span class="p">,</span> <span class="s1">&#39;CREATE EXTENSION postGIS;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
            <span class="n">log_activity</span><span class="p">(</span><span class="n">database_name</span><span class="p">,</span> <span class="s2">&quot;pGIS.make_new_database&quot;</span><span class="p">,</span> <span class="s2">&quot;Added PostGIS&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;PostGIS exists by default in </span><span class="si">{database_name}</span><span class="s1">&#39;</span>
            <span class="n">log_activity</span><span class="p">(</span><span class="n">database_name</span><span class="p">,</span> <span class="s2">&quot;pGIS.make_new_database&quot;</span><span class="p">,</span> <span class="s2">&quot;PostGIS exists by default&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Load the custom SQL hexagon grid function</span>
        <span class="n">load_hexgrid_function</span><span class="p">(</span><span class="n">database_name</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{database_name}</span><span class="s1"> already exists at </span><span class="si">{host}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<span class="c1">################################################################################</span>
<span class="c1"># LOAD A DATABASE DUMP FILE</span>
<span class="c1">################################################################################</span>


<div class="viewcode-block" id="load_database_file"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.load_database_file">[docs]</a><span class="k">def</span> <span class="nf">load_database_file</span><span class="p">(</span>
        <span class="n">sql_file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">database_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a ``.sql`` file to a new database.</span>
<span class="sd">    NOTE: ``psql`` must be accessible on the system path</span>

<span class="sd">    TODO: type hints and params. Add port to psql URI</span>

<span class="sd">    :param sql_file_path: &#39;/path/to/sqlfile.sql&#39;</span>
<span class="sd">    :param database_name: &#39;new_db_name&#39;</span>
<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="n">path_list</span> <span class="o">=</span> <span class="n">sql_file_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">sql_file</span> <span class="o">=</span> <span class="n">path_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Loading </span><span class="si">{sql_file}</span><span class="s1"> to </span><span class="si">{database_name}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">make_new_database</span><span class="p">(</span><span class="n">database_name</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;psql &quot;postgresql://</span><span class="si">{username}</span><span class="s1">:</span><span class="si">{password}</span><span class="s1">@</span><span class="si">{host}</span><span class="s1">/</span><span class="si">{database_name}</span><span class="s1">&quot; &lt;  &quot;</span><span class="si">{sql_file_path}</span><span class="s1">&quot;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="n">log_activity</span><span class="p">(</span><span class="n">database_name</span><span class="p">,</span> <span class="s2">&quot;pGIS.load_database_file&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span></div>


<span class="c1">################################################################################</span>
<span class="c1"># WRITE DATA FROM FILE TO THE DATABASE</span>
<span class="c1">################################################################################</span>


<div class="viewcode-block" id="dataframe_to_postgis"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.dataframe_to_postgis">[docs]</a><span class="k">def</span> <span class="nf">dataframe_to_postgis</span><span class="p">(</span>
        <span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a ``pandas.DataFrame`` to a PostgreSQL database.</span>

<span class="sd">    :param db_name: &#39;name_of_the_database&#39;</span>
<span class="sd">    :param dataframe: ``pandas.DataFrame``</span>
<span class="sd">    :param table_name: &#39;name_of_the_table&#39;</span>
<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;WRITING </span><span class="si">{table_name}</span><span class="s1">//</span><span class="si">{db_name}</span><span class="s1">//</span><span class="si">{host}</span><span class="s1"> FROM DATAFRAME&#39;</span><span class="p">)</span>

    <span class="c1"># FORCE ALL COLUMN NAMES TO LOWER-CASE (pgSQL requirement)</span>
    <span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

    <span class="c1"># CONNECT TO DATABASE, WRITE DATAFRAME, THEN DISCONNECT</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">make_database_connection</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="s1">&#39;sqlalchemy&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
    <span class="n">dataframe</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="c1"># REPORT THE RUNTIME</span>
        <span class="n">runtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;FINISHED IN </span><span class="si">{runtime}</span><span class="s1"> SECONDS&#39;</span><span class="p">)</span>

    <span class="n">log_activity</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="s2">&quot;pGIS.dataframe_to_postgis&quot;</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;Wrote pandas.DataFrame to </span><span class="si">{table_name}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span></div>


<div class="viewcode-block" id="csv_to_postgis"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.csv_to_postgis">[docs]</a><span class="k">def</span> <span class="nf">csv_to_postgis</span><span class="p">(</span>
        <span class="n">csv_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write ``.CSV`` file to a database.</span>
<span class="sd">    Accomplished by importing to a ``pandas.DataFrame`` and calling ``dataframe_to_postgis()``.</span>

<span class="sd">    TODO: params</span>

<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;READING </span><span class="si">{csv_filepath}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Does this table already exist? In order to overwrite it you have to drop the existing table first</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">get_list_of_tables_in_db</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{table_name}</span><span class="s1"> ALREADY EXISTS... DROPPING TABLE CASCADE&#39;</span><span class="p">)</span>
            <span class="n">drop_table</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Read .CSV file into Pandas</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_filepath</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_filepath</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ISO-8859-1&quot;</span><span class="p">)</span>

    <span class="c1"># Replace &quot;Column Name&quot; with &quot;column_name&quot;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

    <span class="c1"># Remove &#39;.&#39; and &#39;-&#39; from column names.</span>
    <span class="c1"># i.e. &#39;geo.display-label&#39; becomes &#39;geodisplaylabel&#39;</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">log_activity</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="s2">&quot;pGIS.csv_to_postgis&quot;</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;Loaded CSV from </span><span class="si">{csv_filepath}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># Save dataframe to database</span>
    <span class="n">dataframe_to_postgis</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span></div>


<div class="viewcode-block" id="geodataframe_to_postgis"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.geodataframe_to_postgis">[docs]</a><span class="k">def</span> <span class="nf">geodataframe_to_postgis</span><span class="p">(</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">geodataframe</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span>
        <span class="n">output_table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">src_epsg</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_epsg</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a ``geopandas.GeoDataFrame`` to a PostGIS table in a SQL database.</span>

<span class="sd">    Assumes that the geometry column has already been named &#39;geometry&#39;</span>

<span class="sd">    :param database: &#39;name_of_the_database&#39;</span>
<span class="sd">    :param geodataframe: geopandas.GeoDataFrame</span>
<span class="sd">    :param output_table_name: &#39;name_of_the_output_table&#39;</span>
<span class="sd">    :param src_epsg: if not None, will assign the geodataframe this EPSG in the format of {&quot;init&quot;: &quot;epsg:2227&quot;}</span>
<span class="sd">    :param output_epsg: if not None, will reproject data from input EPSG to specified EPSG</span>
<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="c1"># Get the geometry type</span>
    <span class="c1"># It&#39;s possible there are both MULTIPOLYGONS and POLYGONS. This grabs the MULTI variant</span>
    <span class="n">geom_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">geodataframe</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">geom_type</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">geom_typ</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">geom_types</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> PROCESSING </span><span class="se">\t</span><span class="s1"> </span><span class="si">{geom_typ}</span><span class="s1"> </span><span class="se">\t</span><span class="s1"> </span><span class="si">{output_table_name}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Manually set the EPSG if the user passes one</span>
    <span class="k">if</span> <span class="n">src_epsg</span><span class="p">:</span>
        <span class="n">geodataframe</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;init&quot;</span><span class="p">:</span> <span class="n">f</span><span class="s2">&quot;epsg:</span><span class="si">{src_epsg}</span><span class="s2">&quot;</span><span class="p">}</span>
        <span class="n">epsg_code</span> <span class="o">=</span> <span class="n">src_epsg</span>

    <span class="c1"># Otherwise, try to get the EPSG value directly from the geodataframe</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># gdf should have a CRS stored like this: {&#39;init&#39;: &#39;epsg:4326&#39;}</span>
            <span class="n">epsg_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">geodataframe</span><span class="o">.</span><span class="n">crs</span><span class="p">[</span><span class="s1">&#39;init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This geodataframe does not have a valid EPSG. Aborting.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">geodataframe</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
            <span class="k">return</span>


    <span class="c1"># Sanitize the columns before writing to the database</span>
    <span class="c1"># Make all column names lower case</span>
    <span class="n">geodataframe</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">geodataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

    <span class="c1"># Replace the &#39;geom&#39; column with &#39;geometry&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">in</span> <span class="n">geodataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">geodataframe</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geodataframe</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">]</span>
        <span class="n">geodataframe</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;geom&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Drop the &#39;gid&#39; column</span>
    <span class="k">if</span> <span class="s1">&#39;gid&#39;</span> <span class="ow">in</span> <span class="n">geodataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">geodataframe</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;gid&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Rename &#39;unique_id&#39; to &#39;old_uid&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;unique_id&#39;</span> <span class="ow">in</span> <span class="n">geodataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">geodataframe</span><span class="p">[</span><span class="s1">&#39;old_uid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geodataframe</span><span class="p">[</span><span class="s1">&#39;unique_id&#39;</span><span class="p">]</span>
        <span class="n">geodataframe</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Build a &#39;geom&#39; column using geoalchemy2 and drop the source &#39;geometry&#39; column</span>
    <span class="n">geodataframe</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geodataframe</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">WKTElement</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">wkt</span><span class="p">,</span> <span class="n">srid</span><span class="o">=</span><span class="n">epsg_code</span><span class="p">))</span>
    <span class="n">geodataframe</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># write geodataframe to SQL database</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> WRITING TO - </span><span class="si">{database}</span><span class="s1"> /// </span><span class="si">{host}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">engine</span> <span class="o">=</span> <span class="n">make_database_connection</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s1">&#39;sqlalchemy&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
    <span class="n">geodataframe</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">output_table_name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span>
                        <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index_label</span><span class="o">=</span><span class="s1">&#39;gid&#39;</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;geom&#39;</span><span class="p">:</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">geom_typ</span><span class="p">,</span> <span class="n">srid</span><span class="o">=</span><span class="n">epsg_code</span><span class="p">)})</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">runtime</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> FINISHED IN </span><span class="si">{runtime}</span><span class="s1"> seconds&#39;</span><span class="p">)</span>

    <span class="n">log_activity</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;pGIS.geodataframe_to_postgis&quot;</span><span class="p">,</span>
                 <span class="n">f</span><span class="s2">&quot;Wrote geopandas.GeoDataFrame to </span><span class="si">{output_table_name}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># If provided an EPSG, alter whatever the native projection was to the output_epsg</span>
    <span class="k">if</span> <span class="n">output_epsg</span><span class="p">:</span>
        <span class="n">project_spatial_table</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">output_table_name</span><span class="p">,</span> <span class="n">geom_typ</span><span class="p">,</span> <span class="n">epsg_code</span><span class="p">,</span> <span class="n">output_epsg</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># Add a unique_id column and do a spatial index</span>
    <span class="n">prep_spatial_table</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">output_table_name</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span></div>


<div class="viewcode-block" id="shp_to_postgis"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.shp_to_postgis">[docs]</a><span class="k">def</span> <span class="nf">shp_to_postgis</span><span class="p">(</span>
        <span class="n">shp_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">src_epsg</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_epsg</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a ``shapefile`` into ``geopandas.GeoDataFrame`` and then use ``geodataframe_to_postgis()``</span>

<span class="sd">    TODO: type hints and params</span>

<span class="sd">    :param shp_path:  r&#39;c:\path\to\your\shapefile.shp&#39;</span>
<span class="sd">    :param output_table_name: &#39;name_of_the_output_table&#39;</span>
<span class="sd">    :param database: &#39;name_of_the_sql_database&#39;</span>
<span class="sd">    :param src_epsg: if not None, will assign the geodataframe this EPSG in the format of {&quot;init&quot;: &quot;epsg:2227&quot;}</span>
<span class="sd">    :param output_epsg: if not None, will reproject data from input EPSG to specified EPSG</span>
<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;READING - </span><span class="si">{shp_path}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># READ THE .SHP INTO A GEOPANDAS.GEODATAFRAME</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">shp_path</span><span class="p">)</span>

    <span class="c1"># REMOVE ROWS WITH NULL GEOMETRY</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>

    <span class="c1"># EXPLODE TO TRANSFORM ANY MULTIPART FEATURES TO SINGPLEPART</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span>

    <span class="c1"># RESET THE INDEX AFTER EXPLODING</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;explode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="n">log_activity</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;pGIS.shp_to_postgis&quot;</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;Loaded .SHP from </span><span class="si">{shp_path}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># SEND THE GEODATAFRAME TO POSTGIS</span>
    <span class="n">geodataframe_to_postgis</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">output_table_name</span><span class="p">,</span> <span class="n">src_epsg</span><span class="o">=</span><span class="n">src_epsg</span><span class="p">,</span> <span class="n">output_epsg</span><span class="o">=</span><span class="n">output_epsg</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span></div>


<div class="viewcode-block" id="shp2pgsql"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.shp2pgsql">[docs]</a><span class="k">def</span> <span class="nf">shp2pgsql</span><span class="p">(</span>
        <span class="n">shp_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">new_pg_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">srid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use the command-line ``shp2pgsql`` operation to ingest a shapefile,</span>
<span class="sd">    and pipe it into PostGIS using ``psql``</span>

<span class="sd">    TODO: add handling for machines where PSQL is not on path</span>
<span class="sd">    TODO: add handling for machines that are picky about the db password</span>
<span class="sd">    TODO: type hints and params</span>

<span class="sd">    :param shp_path:</span>
<span class="sd">    :param new_pg_name:</span>
<span class="sd">    :param database:</span>
<span class="sd">    :param srid:</span>
<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;shp2pgsql -s </span><span class="si">{srid}</span><span class="s2"> -I </span><span class="si">{shp_path}</span><span class="s2"> </span><span class="si">{new_pg_name}</span><span class="s2"> | psql -U </span><span class="si">{username}</span><span class="s2"> -d </span><span class="si">{database}</span><span class="s2"> -h </span><span class="si">{host}</span><span class="s2">&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">command</span><span class="p">)</span></div>


<span class="c1">################################################################################</span>
<span class="c1"># SAVE FILES OUT FROM THE DATABASE</span>
<span class="c1">################################################################################</span>


<div class="viewcode-block" id="postgis_to_shp"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.postgis_to_shp">[docs]</a><span class="k">def</span> <span class="nf">postgis_to_shp</span><span class="p">(</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">geom_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;geom&#39;</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a spatial PostGIS table to a shapfile using ``query_geo_table().to_file()``</span>

<span class="sd">    :param database: &#39;name_of_the_database&#39;</span>
<span class="sd">    :param table_name: &#39;name_of_the_table&#39;</span>
<span class="sd">    :param output_folder: r&#39;c:\\path\\to\\your\\output\\shapefile\\folder&#39;</span>
<span class="sd">    :param geom_col: &#39;geom&#39; is default spatial column name in postGIS</span>
<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Creating shapefile from </span><span class="si">{table_name}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">query_geo_table</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;SELECT * FROM </span><span class="si">{table_name}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">geom_col</span><span class="o">=</span><span class="n">geom_col</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># Convert any boolean column types to strings</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">datatype</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;bool&#39;</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="n">out_shp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{table_name}</span><span class="s1">.shp&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">out_shp</span><span class="p">)</span>

        <span class="n">log_activity</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s2">&quot;pGIS.postgis_to_shp&quot;</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;Saved .SHP from </span><span class="si">{table_name}</span><span class="s2"> to </span><span class="si">{out_shp}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="dump_all_spatial_tables_to_shapefiles"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.dump_all_spatial_tables_to_shapefiles">[docs]</a><span class="k">def</span> <span class="nf">dump_all_spatial_tables_to_shapefiles</span><span class="p">(</span>
        <span class="n">database_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write all spatial tables in a PostGIS database to a subfolder of the output_folder.</span>

<span class="sd">    :param database_name: &#39;name_of_the_database&#39;</span>
<span class="sd">    :param output_folder: folder path, e.g. r&#39;C:\Egnyte\Shared\SERVICE_AREA\Analytics\data\Projects\El Dorado&#39;</span>
<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="c1"># put everything into a subfolder. Make it if it doesn&#39;t exist</span>
    <span class="n">dump_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;shps_from_pgdb_</span><span class="si">{database_name}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dump_folder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dump_folder</span><span class="p">)</span>

    <span class="n">log_activity</span><span class="p">(</span><span class="n">database_name</span><span class="p">,</span> <span class="s2">&quot;pGIS.dump_all_spatial_tables_to_shapefiles&quot;</span><span class="p">,</span>
                 <span class="n">f</span><span class="s2">&quot;Saving all spatial tables to SHP in </span><span class="si">{dump_folder}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># Get a list of all spatial tables and export each one</span>
    <span class="n">spatial_tables</span> <span class="o">=</span> <span class="n">get_list_of_spatial_tables_in_db</span><span class="p">(</span><span class="n">database_name</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">spatial_tables</span><span class="p">:</span>
        <span class="n">postgis_to_shp</span><span class="p">(</span><span class="n">database_name</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">dump_folder</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span></div>


<div class="viewcode-block" id="dump_database_to_sql_file"><a class="viewcode-back" href="../../postGIS_tools.functions.html#postGIS_tools.functions.dump_database_to_sql_file">[docs]</a><span class="k">def</span> <span class="nf">dump_database_to_sql_file</span><span class="p">(</span>
        <span class="n">db_to_backup</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">backup_folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PG_PASSWORD</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Save a database stored on a host to a .sql file, using TERMINAL on OSX</span>

<span class="sd">    TODO: update with declaration of username and port</span>

<span class="sd">    :param db_to_backup: &#39;name_of_db&#39;</span>
<span class="sd">    :param backup_folder: &#39;/Users/my_name/Desktop/backup_folder&#39;</span>
<span class="sd">    :param host: name of the pgSQL host (string). eg: &#39;localhost&#39; or &#39;192.168.1.14&#39;</span>
<span class="sd">    :param username: valid PostgreSQL database username (string). eg: &#39;postgres&#39;</span>
<span class="sd">    :param password: password for the supplied username (string). eg: &#39;mypassword123&#39;</span>
<span class="sd">    :param port: port number for the PgSQL database. eg: 5432</span>
<span class="sd">    :param debug: boolean to print messages to console</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">debug</span><span class="p">}</span>

    <span class="c1"># Get a string for today&#39;s date, like &#39;2019_02_26&#39;</span>
    <span class="n">today</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>

    <span class="c1"># USE PG_DUMP VIA COMMAND LINE TO SAVE A .SQL FILE</span>
    <span class="n">sql_file</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{db_to_backup}</span><span class="s1">_</span><span class="si">{today}</span><span class="s1">.sql&#39;</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Using pg_dump to back up </span><span class="si">{db_to_backup}</span><span class="s1"> to </span><span class="si">{sql_file}</span><span class="s1">&#39;</span><span class="p">)</span>


    <span class="n">log_activity</span><span class="p">(</span><span class="n">db_to_backup</span><span class="p">,</span> <span class="s1">&#39;pGIS.dump_database_to_sql_file&#39;</span><span class="p">,</span>
                 <span class="n">f</span><span class="s2">&quot;Using pg_dump to create </span><span class="si">{sql_file}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">THIS_SYSTEM</span> <span class="o">==</span> <span class="s1">&#39;Darwin&#39;</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot; export PGPASSWORD=</span><span class="si">{password}</span><span class="s2"></span>
<span class="s2">                 cd &quot;</span><span class="si">{backup_folder}</span><span class="s2">&quot;</span>
<span class="s2">                 pg_dump -U postgres -h </span><span class="si">{host}</span><span class="s2"> </span><span class="si">{db_to_backup}</span><span class="s2"> &gt; </span><span class="si">{sql_file}</span><span class="s2"> &quot;&quot;&quot;</span>

    <span class="k">elif</span> <span class="n">THIS_SYSTEM</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span><span class="p">:</span>
        <span class="n">bkp_drive</span> <span class="o">=</span> <span class="n">backup_folder</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot; set PGPASSWORD=</span><span class="si">{password}</span><span class="s2"></span>
<span class="s2">                 </span><span class="si">{bkp_drive}</span><span class="s2"></span>
<span class="s2">                 cd &quot;</span><span class="si">{backup_folder}</span><span class="s2">&quot;</span>
<span class="s2">                 pg_dump -U postgres -h </span><span class="si">{host}</span><span class="s2"> </span><span class="si">{db_to_backup}</span><span class="s2"> &gt; </span><span class="si">{sql_file}</span><span class="s2"> &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">             &#39;</span><span class="p">,</span> <span class="s1">&#39;&amp; &#39;</span><span class="p">)</span>

    <span class="c1"># RUN THE COMMAND FROM COMMAND LINE</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">c</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Aaron Fraint, AICP

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>